<!doctype html>
<html>
    <head>
        <title id="title">Poggers Music Queue</title>
        <!-- Load CSS + JS -->
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='2-sort-list.css') }}"
        />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="{{ url_for('static', filename='3-sort-list.js') }}"></script>
    </head>
    <body>
        <div class="header">
            <h1>Poggers Music Queue</h1>
            <p>Drag and drop to sort the list.</p>
        </div>

        <div class="upnext">
            <h2>Up Next</h2>
            <h3>____________________</h3>
        </div>
        <div class="current">
            <div class="firstimgcontainer"><img id="firstthumb" src="" /></div>
            <div class="currenttitle" id="first"></div>
            <div class="controls" id="second">
                <button class="playpause" id="playpause">Play/Pause</button>
                <button class="skip" id="skip">Skip</button>
                <button class="shuffle" id="shuffle">Shuffle</button>
                <button class="loop" id="loop">Loop</button>
            </div>
        </div>
        <div class="plcontainer">
        <ul id="sortlist">
            {% for song in playlist %}
            <li>
                <div class="songnumber"></div>
                <img src="{{ song['thumbnail'] }}" />
                <div class="songtitle">{{ song['name'] }}</div>
                <div class="songbuttons">
                    <button class="songplay" id="play">Play</button>
                    <button class="songlink" id="link">Link</button>
                    <button class="songdelete" id="delete">Delete</button>
                </div>
            </li>
            {% endfor %}
            <!-- Display data here -->
        </ul>
        <div class="extrainfo" id="extrainfo">
            <p class="pllength" id="pllength"></p>
        </div>        
        </div>
        <div
            class="clickblocker"
            id="clickblocker"
            style="width: 0%; height: 0%; position: fixed"
        ></div>
        <div id="slidingDiv">
            <div class="addsong" id="addsong">
                <div class="searchcontainer" id="searchcontainer">
                    <h2>Add Song</h2>
                    <form id="addform">
                        <input
                            type="text"
                            name="addurl"
                            id="addurl"
                            placeholder="Enter URL or search"
                        />
                        <div class="addnextcontainer">
                            <p>Play Next?</p>
                            <input
                                type="checkbox"
                                name="addnext"
                                id="addnext"
                                class="addnext"
                            />
                        </div>
                        <input
                            type="submit"
                            value="Search/Add to queue"
                            class="addbutton"
                        />
                    </form>
                </div>
                <ul id="searchresults"></ul>
                <p id="clicktoslideout">Click to add song</p>
            </div>
        </div>
        <script>
            // get guild name from url args
            const urlParams = new URLSearchParams(window.location.search);
            const guild = urlParams.get("guild");
            function fetchData() {
                fetch("/get_data?guild=" + guild)
                    .then((response) => response.json())
                    .then((data) => {
                        const playlist = data.playlist;
                        const pllength = data.pllength;
                        const sortlist = document.getElementById("sortlist");
                        sortlist.innerHTML = ""; // Clear the existing list

                        playlist.forEach((song, index) => {
                            const li = document.createElement("li");
                            const img = document.createElement("img");
                            const div1 = document.createElement("div");
                            const div2 = document.createElement("div");
                            const div3 = document.createElement("div");
                            const div4 = document.createElement("div");
                            const div5 = document.createElement("div");
                            const button1 = document.createElement("button");
                            const a2 = document.createElement("a");
                            const button2 = document.createElement("button");
                            const button3 = document.createElement("button");

                            img.src = song.thumbnail;
                            li.dataset.id = song.id;
                            li.dataset.url = song.url;
                            li.dataset.guild = guild;
                            li.dataset.name = song.name;
                            li.className = "songli";
                            div1.innerText = song.name;
                            div1.className = "songtitle";
                            div2.innerText = "...";
                            div2.style = "color: #5B5B66;";
                            div3.className = "songbuttons";
                            div4.innerText = song.id + ". - ";
                            div4.style = "white-space: pre;";
                            div5.className = "duration";
                            div5.innerText = song.duration;
                            button1.innerText = "Play";
                            button2.innerText = "Link";
                            a2.href = song.url;
                            a2.target = "_blank";
                            button3.innerText = "Delete";
                            button1.className = "songplay";
                            button2.className = "songlink";
                            button3.className = "songdelete";
                            button1.id = "songplay";
                            button2.id = "songlink";
                            button3.id = "songdelete";

                            li.appendChild(div4);
                            li.appendChild(img);
                            li.appendChild(div2);
                            li.appendChild(div1);
                            li.appendChild(div5);
                            li.appendChild(div3);
                            div3.appendChild(button1);
                            div3.appendChild(a2);
                            a2.appendChild(button2);
                            div3.appendChild(button3);

                            sortlist.appendChild(li);

                            if (index === 0) {
                                li.draggable = false;
                                li.style = "background-color: #5B5B66;";
                                var firstname = song.name;
                                var firstthumb = song.thumbnail;
                                firstthumb = firstthumb.replace(
                                    "mqdefault",
                                    "maxresdefault",
                                );
                                document.getElementById("first").innerHTML =
                                    firstname;
                                document.getElementById("firstthumb").src =
                                    firstthumb;
                            }
                            button1.addEventListener("click", async () => {
                                const response = await fetch("/play_song", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        id: song.id,
                                        url: song.url,
                                        guild: guild,
                                    }),
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                            button3.addEventListener("click", async () => {
                                const response = await fetch("/delete_song", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        id: song.id,
                                        url: song.url,
                                        guild: guild,
                                    }),
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                            li.addEventListener("dragend", async () => {
                                const updatedListJSON = getUpdatedListJSON();
                                const response = await fetch("/update_list", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: updatedListJSON,
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                        });
                        const pllengthdiv = document.getElementById(
                            "pllength",
                        );
                        pllengthdiv.dataset.pllength = pllength;
                        pllengthdiv.innerText = pllength + " songs in queue";
                        slist(sortlist);
                    });
            }
            let debounceTimeout;

            const skip = document.getElementById("skip");
            skip.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/skip_song", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: guild,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300); // Adjust the delay as needed
            });

            const playpause = document.getElementById("playpause");
            playpause.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/playpause", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: guild,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300); // Adjust the delay as needed
            });

            const shuffle = document.getElementById("shuffle");
            shuffle.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const sortlist = document.getElementById("sortlist");
                    const firstsong = sortlist.firstChild;
                    sortlist.style.transition = "opacity 0s";
                    sortlist.style.opacity = "0.5";
                    firstsong.style.opacity = "1";
                    setTimeout(function () {
                        sortlist.style.transition = "opacity 3s";
                        sortlist.style.opacity = "1";
                    }, 6000);
                    const response = await fetch("/shuffle", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: guild
                        }),
                    });
                    
                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300);
            });

            const loop = document.getElementById("loop");
            loop.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/loop", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: guild,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    if (data.looping === true) {
                        document.getElementById("loop").style =
                            "background: #0b6122;";
                    } else {
                        document.getElementById("loop").style =
                            "background: darkgray;";
                    }
                    fetchData();
                }, 300); // Adjust the delay as needed
            });
            function getUpdatedListJSON() {
                const sortlist = document.getElementById("sortlist");
                const updatedList = [];
                const lis = sortlist.getElementsByTagName("li");
                for (let i = 0; i < lis.length; i++) {
                    const li = lis[i];
                    const id = li.dataset.id;
                    const name = li.dataset.name;
                    const url = li.dataset.url;
                    updatedList.push({
                        id,
                        name,
                        url,
                        guild,
                    });
                }
                return JSON.stringify(updatedList);
            }
            const clicktoslideout = document.getElementById("clicktoslideout");
            const slidingDiv = document.getElementById("slidingDiv");
            const searchcontainer = document.getElementById("searchcontainer");
            const searchresults = document.getElementById("searchresults");
            const form = document.getElementById("addform");
            const clickblocker = document.getElementById("clickblocker");
            function slidesearch() {
                if (slidingDiv.style.top == "-163px") {
                    clickblocker.style.width = "100%";
                    clickblocker.style.height = "100%";
                    slidingDiv.style.top = "-20px";
                    clicktoslideout.innerHTML = "Click to hide";
                } else {
                    clickblocker.style.width = "0%";
                    clickblocker.style.height = "0%";
                    slidingDiv.style.top = "-163px";
                    slidingDiv.style.height = "143px";
                    searchcontainer.style.height = "100%";
                    searchresults.style.height = "0%";
                    searchresults.style.opacity = "0";
                    searchresults.innerHTML = "";
                    clicktoslideout.innerHTML = "Click to add song";
                }
            }
            clicktoslideout.addEventListener("click", () => {
                slidesearch();
            });
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    searchresults.style.opacity = "0";
                    searchresults.innerHTML = "";
                    const response = await fetch("/add_song", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            addurl: form.addurl.value,
                            addnext: form.addnext.checked,
                            guild: guild,
                        }),
                    });
                    const data = await response.json();
                    console.log(data);
                    if (data.is_playlist == false && data.is_url == false) {
                        const results = data.results;
                        const searchresults =
                            document.getElementById("searchresults");
                        slidingDiv.style.height = "60%";
                        searchcontainer.style.height = "25%";
                        searchresults.style.height = "75%";
                        searchresults.style.opacity = "1";
                        results.forEach((result, i) => {
                            const searchurl = result.url;
                            const searchname = result.title;
                            const searchimg =
                                "https://img.youtube.com/vi/" +
                                result.url.split("v=")[1] +
                                "/mqdefault.jpg";
                            const searchduration = result.duration;
                            const li = document.createElement("li");
                            const num = document.createElement("span");
                            const img = document.createElement("img");
                            const name = document.createElement("span");
                            const duration = document.createElement("span");
                            const link = document.createElement("a");
                            const linkbutton = document.createElement("button");
                            num.innerHTML = i + 1 + ".";
                            num.style = "margin-right: 10px;";
                            li.appendChild(num);
                            img.src = searchimg;
                            img.style = "margin-right: 10px;";
                            li.appendChild(img);
                            name.innerHTML = searchname;
                            name.style = "white-space: nowrap; overflow: hidden; width: 500%; text-overflow: ellipsis;";
                            li.appendChild(name);
                            duration.innerHTML = searchduration;
                            duration.style =
                                "display: flex; justify-content: flex-end; width: 100%; margin-left: 10px;";
                            li.appendChild(duration);
                            link.href = searchurl;
                            link.target = "_blank";
                            link.style = "margin-left: 10px;";
                            linkbutton.innerHTML = "Link";
                            link.appendChild(linkbutton);
                            li.appendChild(link);
                            li.dataset.url = searchurl;
                            li.dataset.name = searchname;
                            li.addEventListener("click", async () => {
                                if (debounceTimeout) {
                                    clearTimeout(debounceTimeout);
                                }

                                debounceTimeout = setTimeout(async () => {
                                    const response = await fetch("/add_song", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            addurl: searchurl,
                                            addnext: form.addnext.checked,
                                            guild: guild,
                                        }),
                                    });
                                    const data = await response.json();
                                    console.log(data);
                                    li.style = "background: #078528;";
                                    // slidesearch();
                                    fetchData();
                                }, 300);
                            });
                            searchresults.appendChild(li);
                        });
                    }
                    fetchData();
                }, 300);
            });
            clickblocker.addEventListener("click", () => {
                slidesearch();
            });

            // Fetch data initially
            fetchData();

            // Fetch data every 10 seconds
            setInterval(fetchData, 15000);
        </script>
    </body>
</html>
