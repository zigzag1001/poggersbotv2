<!doctype html>
<html>
    <head>
        <title id="title">Poggers Music Queue</title>
        <!-- Load CSS + JS -->
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='2-sort-list.css') }}"
        />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="{{ url_for('static', filename='3-sort-list.js') }}"></script>
    </head>
    <body>
        <div class="header">
            <h1>Poggers Music Queue</h1>
            <p>Drag and drop to sort the list.</p>
        </div>
        <div class="upnext">
            <h2>Up Next</h2>
            <h3>____________________</h3>
        </div>
        <div class="current">
            <div class="firstimgcontainer"><img id="firstthumb" src="" /></div>
            <div class="currenttitle" id="first"></div>
            <div class="controls" id="second">
                <button class="playpause" id="playpause">Play/Pause</button>
                <button class="skip" id="skip">Skip</button>
                <button class="shuffle" id="shuffle">Shuffle</button>
                <button class="loop" id="loop">Loop</button>
            </div>
        </div>
        <ul id="sortlist">
            {% for song in playlist %}
            <li>
                <div class="songnumber"></div>
                <img src="{{ song['thumbnail'] }}" />
                <div class="songtitle">{{ song['name'] }}</div>
                <div class="songbuttons">
                    <button class="songplay" id="play">Play</button>
                    <button class="songlink" id="link">Link</button>
                    <button class="songdelete" id="delete">Delete</button>
                </div>
            </li>
            {% endfor %}
            <!-- Display data here -->
        </ul>

        <script>
            function fetchData() {
                fetch("/get_data")
                    .then((response) => response.json())
                    .then((data) => {
                        const sortlist = document.getElementById("sortlist");
                        sortlist.innerHTML = ""; // Clear the existing list

                        data.forEach((song, index) => {
                            const li = document.createElement("li");
                            const img = document.createElement("img");
                            const div1 = document.createElement("div");
                            const div2 = document.createElement("div");
                            const div3 = document.createElement("div");
                            const div4 = document.createElement("div");
                            const div5 = document.createElement("div");
                            const button1 = document.createElement("button");
                            const a2 = document.createElement("a");
                            const button2 = document.createElement("button");
                            const button3 = document.createElement("button");

                            img.src = song.thumbnail;
                            li.dataset.id = song.id;
                            li.dataset.url = song.url;
                            li.dataset.guild = song.guild;
                            li.dataset.name = song.name;
                            div1.innerText = song.name;
                            div1.className = "songtitle";
                            div2.innerText = "...";
                            div2.style = "color: #5B5B66;";
                            div3.className = "songbuttons";
                            div4.innerText = song.id + ". - ";
                            div4.style = "white-space: pre;";
                            div5.className = "duration";
                            div5.innerText = song.duration;
                            button1.innerText = "Play";
                            button2.innerText = "Link";
                            a2.href = song.url;
                            a2.target = "_blank";
                            button3.innerText = "Delete";
                            button1.className = "songplay";
                            button2.className = "songlink";
                            button3.className = "songdelete";
                            button1.id = "songplay";
                            button2.id = "songlink";
                            button3.id = "songdelete";

                            li.appendChild(div4);
                            li.appendChild(img);
                            li.appendChild(div2);
                            li.appendChild(div1);
                            li.appendChild(div5);
                            li.appendChild(div3);
                            div3.appendChild(button1);
                            div3.appendChild(a2);
                            a2.appendChild(button2);
                            div3.appendChild(button3);

                            sortlist.appendChild(li);

                            if (index === 0) {
                                li.draggable = false;
                                li.style = "background-color: #5B5B66;";
                                var firstname = song.name;
                                var firstthumb = song.thumbnail;
                                var firstguild = song.guild;
                                firstthumb = firstthumb.replace(
                                    "mqdefault",
                                    "maxresdefault",
                                );
                                document.getElementById("first").innerHTML =
                                    firstname;
                                document.getElementById("firstthumb").src =
                                    firstthumb;
                                document.getElementById("first").title =
                                    firstguild;
                            }
                            button1.addEventListener("click", async () => {
                                const response = await fetch("/play_song", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        id: song.id,
                                        url: song.url,
                                        guild: song.guild,
                                    }),
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                            button3.addEventListener("click", async () => {
                                const response = await fetch("/delete_song", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        id: song.id,
                                        url: song.url,
                                        guild: song.guild,
                                    }),
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                            li.addEventListener("dragend", async () => {
                                const updatedListJSON = getUpdatedListJSON();
                                const response = await fetch("/update_list", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: updatedListJSON,
                                });
                                const data = await response.json();
                                console.log(data);
                                fetchData();
                            });
                        });

                        slist(sortlist);
                    });
            }
            let debounceTimeout;

            const skip = document.getElementById("skip");
            skip.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/skip_song", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: document.getElementById("first").title,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300); // Adjust the delay as needed
            });

            const playpause = document.getElementById("playpause");
            playpause.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/playpause", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: document.getElementById("first").title,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300); // Adjust the delay as needed
            });

            const shuffle = document.getElementById("shuffle");
            shuffle.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/shuffle", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: document.getElementById("first").title,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    fetchData();
                }, 300); // Adjust the delay as needed
            });

            const loop = document.getElementById("loop");
            loop.addEventListener("click", async () => {
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch("/loop", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            guild: document.getElementById("first").title,
                        }),
                    });

                    const data = await response.json();
                    console.log(data);
                    if (data.looping === true) {
                        document.getElementById("loop").style =
                            "background: #0b6122;";
                    } else {
                        document.getElementById("loop").style =
                            "background: darkgray;";
                    }
                    fetchData();
                }, 300); // Adjust the delay as needed
            });
            function getUpdatedListJSON() {
                const sortlist = document.getElementById("sortlist");
                const updatedList = [];
                const lis = sortlist.getElementsByTagName("li");
                for (let i = 0; i < lis.length; i++) {
                    const li = lis[i];
                    const id = li.dataset.id;
                    const name = li.dataset.name;
                    const url = li.dataset.url;
                    const guild = li.dataset.guild;
                    updatedList.push({
                        id,
                        name,
                        url,
                        guild,
                    });
                }
                return JSON.stringify(updatedList);
            }

            // Fetch data initially
            fetchData();

            // Fetch data every 10 seconds
            setInterval(fetchData, 15000);
        </script>
    </body>
</html>
